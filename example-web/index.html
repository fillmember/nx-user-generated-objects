<html>
  <head>
    <title>nx-user-generated-objects</title>
    <link
      href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <main class="container mx-auto border p-8">
      <section class="my-4">
        <h2 class="text-lg mb-2" v-if="user">
          Anonymous User: <span class="text-sm">{{ user.uid }}</span>
        </h2>
        <!-- <div class="text-red-600 my-2" v-if="errorAuth">
          {{ errorAuth.message }}
        </div> -->
      </section>
      <section class="my-4" v-if="user">
        <h2 class="text-lg mb-2">Current Scene: {{scene.current.value}}</h2>
        <div class="grid grid-cols-4 gap-2">
          <label v-for="sceneOption in scene.list">
            <input
              type="radio"
              name="scene"
              :value="sceneOption"
              v-model="scene.current.value"
            />
            {{sceneOption}}
          </label>
        </div>
      </section>
      <section class="my-4" v-if="scene.current.value">
        <h2 class="text-lg mb-2">Objects in {{scene.current.value}}</h2>
        <div class="italic">
          <template v-if="!userGeneratedObjects.list.value">
            no data yet
          </template>
        </div>
        <table class="w-full text-xs" v-if="userGeneratedObjects.list.value">
          <tr class="text-left border-b">
            <th>uid</th>
            <th>object_id</th>
            <th>user_id</th>
            <th>matrix</th>
            <th>actions</th>
          </tr>
          <tr v-for="(value,key) in userGeneratedObjects.list.value">
            <td>{{key}}</td>
            <td>{{value.object_id}}</td>
            <td>{{value.user_id}}</td>
            <td><div class="truncate w-20">{{value.matrix}}</div></td>
            <td>
              <button
                class="underline"
                @click="userGeneratedObjects.delete(key)"
              >
                delete
              </button>
            </td>
          </tr>
        </table>
      </section>
      <section class="my-4 border-t pt-4" v-if="scene.current.value">
        <form class="grid grid-cols-4 gap-2">
          <button
            type="button"
            class="p-2 px-4 shadow rounded bg-blue-200"
            @click="userGeneratedObjects.add"
          >
            new object
          </button>
        </form>
      </section>
    </main>
    <!-- scripts -->
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.4/firebase.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAiMqEr6SpjN61sLKFUd3NndRFXV7m_X70", // Auth / General Use
        appId: "1:837039980734:web:200f93d50c52a11a9cdeef", // General Use
        projectId: "nx-user-generated-objects", // General Use
        authDomain: "localhost", // Auth with popup/redirect
        databaseURL:
          "https://nx-user-generated-objects-default-rtdb.europe-west1.firebasedatabase.app/", // Realtime Database
      };
      Vue.createApp({
        setup() {
          // Firebase
          const project = firebase.initializeApp(firebaseConfig);
          // User
          const auth = firebase.auth();
          const user = Vue.ref(null);
          Vue.onBeforeMount(() => {
            auth.signInAnonymously().catch((error) => {});
            auth.onAuthStateChanged((userData) => {
              if (userData) {
                user.value = userData;
              }
            });
          });
          // Scene
          const sceneList = ["yeeLand", "miLand", "stage1", "stage2"];
          const scene = {
            list: sceneList,
            current: Vue.ref(sceneList[0]),
          };
          // Objects from db
          const address = Vue.computed(
            () => `/${["objects", scene.current.value].join("/")}`
          );
          const database = firebase.database();
          const userGeneratedObjectList = Vue.ref(null);
          const onData = (snapshot) => {
            userGeneratedObjectList.value = snapshot.val();
          };
          const dbRef = Vue.computed(() => {
            if (!scene.current.value) return null;
            const ref = database.ref(address.value);
            ref.on("value", onData);
            return ref;
          });
          // unsubscribe old database ref
          Vue.watch(dbRef, (newDBRef, oldDBRef) => {
            if (oldDBRef) {
              oldDBRef.off("value", onData);
            }
          });
          const userGeneratedObjects = {
            list: userGeneratedObjectList,
            add() {
              if (!dbRef.value) return;
              dbRef.value.push(
                {
                  user_id: user.value.uid,
                  object_id: "test",
                  matrix: [Math.random()].toString(),
                },
                (error) => {
                  if (error) {
                    console.log(error);
                  }
                }
              );
            },
            delete(key) {
              if (!dbRef.value) return;
              database.ref(address.value + "/" + key).remove();
            },
          };
          return {
            scene,
            user,
            userGeneratedObjects,
          };
        },
      }).mount("main");
    </script>
  </body>
</html>
